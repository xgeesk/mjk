let e=document.createElement("style");e.innerHTML="#app{top:50%;left:50%;z-index:9;position:absolute;pointer-events:none;width:min(99.9vw,178vh);height:min(99.9vh,56vw);transform:translate(-50%,-50%)}#app *{color:#999;font-size:1rem;font-family:monospace}",document.head.appendChild(e);const t=(e,t)=>Array.from({length:e},((e,n)=>t(n))),n=e=>new Promise((t=>setTimeout(t,e)));const i=e=>{return t="keyup",n=e,window.addEventListener(t,n),()=>window.removeEventListener(t,n);var t,n},o=[1];t(134,(e=>o.push(o[e]*(e+1))));const r=(e,t)=>o[e]/(o[e-t]*o[t]),l={},a=(e,t)=>new Proxy({},{get:(n,i)=>n[i]||(n[i]=(n=l)=>new Promise(((o,r)=>{window.app.NetAgent[e](t,i,n,((e,t)=>e?r(e):o(t)))})))}),p=a("sendReq2MJ","FastTest"),s=a("sendReq2Lobby","Lobby");let c=null,d=null;const u=()=>window.uiscript.UI_WaitingRoom.Inst,f=e=>{u().updateData(e),u().show(),d=e.owner_id,c=e.room_id},y=()=>s.leaveRoom().then((()=>{c=null,u().hide()}));const h=(e=null)=>{c=e};let g=!1;const x=e=>{g=!!e},m=()=>window.game.Scene_MJ.Inst.GameEnd(),v=()=>Promise.all([p.terminateGame(),p.voteGameEnd({yes:!0})]).then((()=>{g=!1,h(),m()})),w={cancel_operation:!0},_=e=>{if(!e)return;const{type:t,timeuse:n=2}=e;return p[1===t||7===t?"inputOperation":"inputChiPengGang"](null===t?w:{...e,timeuse:n})},k=(e=-1)=>p.syncGame({round_id:e}),b=["EndGameVote","GameBroadcast","PlayerLoadGameReady"],I={all:M=M||new Map,on:function(e,t){var n=M.get(e);n&&n.push(t)||M.set(e,[t])},off:function(e,t){var n=M.get(e);n&&n.splice(n.indexOf(t)>>>0,1)},emit:function(e,t){(M.get(e)||[]).slice().map((function(e){e(t)})),(M.get("*")||[]).slice().map((function(n){n(e,t)}))}};var M;const E=e=>({runWith(t){I.emit(e,t)},once:!1}),N=E("e"),P=E("i"),R=E("s"),C=new Map;function G(e){const{step:t,name:n,data:i}=e;C.has(n)||C.set(n,window.net.ProtobufManager.lookupType("lq."+n)),I.emit("a",{step:t,name:n.substring(6),data:C.get(n).decode(i)})}const q=()=>window.view?.DesktopMgr?.Inst;let D=null;const L=(e,t)=>(I.on(e,t),()=>I.off(e,t)),O=e=>L("e",e),A=e=>L("i",e);let S=null;const T=()=>{return s.fetchAccountInfo(e&&{account_id:e}).then((e=>{S=e.account.account_id}));var e},$=()=>window.uiscript.UI_PiPeiYuYue.Inst;let j=!1;const z=(e=31)=>{$().cancelPiPei(e),j=!1};let W=null;function J(e={}){e.t=0,x(!!D?.active),h(D?.game_config?.meta?.room_id);const t=t=>{t&&(e.t=t),setTimeout(n,1e3)},n=()=>{c?(e.t-=1,e.t<1?s.startRoom():t()):e.t=0},o=async()=>{g||c||(j&&await z(),await async function(e={}){c&&await y();const t=e.mode||1,n=e.sanma?0:1,i={shiduan:!0,bianjietishi:!0,fanfu:e.minHan||1,ai_level:e.easy?1:2,dora_count:e.akadora||3,init_point:e.start||25e3,fandian:e.end||27e3,time_fixed:e.time||5,time_add:e.thinking||20},{room:o,error:r}=await s.createRoom({player_count:3+n,mode:{detail_rule:i,mode:t}});if(r||!o)return null;f(o);const l=Math.max(0,parseInt(e.bots)),a=Math.min(2+n,isNaN(l)?5:l);return a&&await s.modifyRoom({robot_count:a}),o}()&&t(3))},r=async()=>{if(!g&&!j)return c&&await y(),((e=31)=>{$().addMatch(e),j=!0})()};var l;W=[(l=()=>x(1),L("s",l)),A((e=>{const{name:t}=Object.getPrototypeOf(e)?.$type;if("NotifyEndGameVote"===t)return void(e.results.find((e=>e.account_id===S))||v());const n=JSON.parse(e.content);var i;n?.room_id&&(i=n.room_id,s.joinRoom({room_id:i}).then((e=>(f(e.room),s.readyPlay({ready:!0,dressing:!1})))))})),O((e=>{e.reason||(x(0),setTimeout((()=>{m(),c&&t(5)}),25e3))})),i((e=>{switch(e.key){case"Backspace":e.preventDefault(),c?g?v():y():j&&z();break;case"Enter":o();break;case"m":r()}}))]}const F=[..."zmps"].flatMap(((e,n)=>t(n?9:7,(t=>`${1+t}${e}`)))),U=new Map(F.map(((e,t)=>[e,t])));["0m","0p","0s"].forEach(((e,t)=>U.set(e,11+9*t)));const H=[],Y=new Map,B=e=>Y.get(e)||0,V=e=>Y.set(e,B(e)+1),K=e=>{const t=e.slice(H.length);return t.forEach((e=>{const t=e[1],n="z"===t,i=((e,t)=>{if(0===e)return 6;if(9===e)return 1;if(t){if(4===e)return 1;if(7===e)return 5}return e+1})(parseInt(e[0]),n);n||5!==i||V(`0${t}`),V(`${i}${t}`)})),H.push(...t),t},Q=Object.assign("pmsz",{p:0,m:1,s:2,z:3});function X(e){if(!e)return"";const{type:t,index:n,dora:i}=e.val||e;return`${i?0:n}${Q[t]}`}const Z=e=>B(X(e)),ee=e=>e.reduce(((e,t)=>e+Z(t)),0),te=e=>[...e].sort(((e,t)=>Z(t)-Z(e))).sort(((e,t)=>e.index-t.index)).sort(((e,t)=>e.type-t.type)),ne=(e,t,n)=>e.filter((e=>e.index==t&&e.type==n)),ie=(e,t,n)=>e.filter((e=>e.index===t&&e.type===n)).length;function oe(e){e=te(e);var t=[],n=0,i=0;return e.forEach((o=>{if(n!=o.index||i!=o.type){var r=ne(e,o.index,o.type);r.length>=2&&(t.push(r[0]),t.push(r[1])),n=o.index,i=o.type}})),t}function re(e){for(var t=te(e),n=[],i=0,o=0;o<t.length;o++)if(!(o!=t.length-1&&t[o].index>=t[o+1].index-1&&t[o].type==t[o+1].type)){var r,l=pe(r=t.slice(i,o+1)),a=se(r=ae(r,l)),p=se(r=t.slice(i,o+1)),s=pe(r=ae(r,p)),c=l.concat(a),d=s.concat(p);(c.length>d.length||c.length==d.length&&ee(c)>ee(d))&&(d=c),n=n.concat(d),i=o+1}return n.length/3}function le(e){var t=te(e);let n=[];for(var i=[],o=0,r=0;r<t.length;r++)if(!(r!=t.length-1&&t[r].index>=t[r+1].index-1&&t[r].type==t[r+1].type)){var l,a=pe(l=t.slice(o,r+1)),p=oe(l=ae(l,a)),s=se(l=ae(l,p)),c=se(l=t.slice(o,r+1)),d=pe(l=ae(l,c)),u=oe(l=ae(l,d)),f=a.concat(s),y=d.concat(c);(f.length>y.length||f.length==y.length&&p.length>u.length||f.length==y.length&&p.length==u.length&&ee(f)>ee(y))&&(y=f,u=p),i=i.concat(y),n=n.concat(u),o=r+1}return{triples:i,pairs:n}}function ae(e,t){for(var n=[...e],i=0;i<t.length;i++)for(var o=0;o<n.length;o++)if(t[i].index==n[o].index&&t[i].type==n[o].type&&t[i].dora==n[o].dora){n.splice(o,1);break}return n}function pe(e){const t=te(e);let n=[],i=0,o=0;return t.forEach((e=>{if(i!=e.index||o!=e.type){let r=ne(t,e.index,e.type);r.length>=3&&(n.push(r[0]),n.push(r[1]),n.push(r[2])),i=e.index,o=e.type}})),n}function se(e){let t=ce(e,[]),n=function(e,t){const n=[...e].sort(((e,t)=>Z(t)-Z(e))).sort(((e,t)=>t.index-e.index)).sort(((e,t)=>e.type-t.type));if(n.length<=2||3==n[0].type)return t;var i=n[0].index,o=n[0].type,r=ne(n,i-1,o),l=ne(n,i-2,o);if(r.length>=1&&l.length>=1){t.push(n[0]),t.push(r[0]),t.push(l[0]);for(var a=0;a<n.length;a++)if(n[a].index==i-1&&n[a].type==o){n.splice(a,1);break}for(a=0;a<n.length;a++)if(n[a].index==i-2&&n[a].type==o){n.splice(a,1);break}return n.splice(0,1),ce(n,t)}return n.splice(0,1),ce(n,t)}(e,[]);return ee(n)>ee(t)&&(t=n),t}function ce(e,t){const n=te(e);if(n.length<=2||3==n[0].type)return t;var i=n[0].index,o=n[0].type,r=ne(n,i+1,o),l=ne(n,i+2,o);if(r.length>=1&&l.length>=1){t.push(n[0]),t.push(r[0]),t.push(l[0]);for(var a=0;a<n.length;a++)if(n[a].index==i+1&&n[a].type==o){n.splice(a,1);break}for(a=0;a<n.length;a++)if(n[a].index==i+2&&n[a].type==o){n.splice(a,1);break}return n.splice(0,1),ce(n,t)}return n.splice(0,1),ce(n,t)}function de(e,t){var n=e.concat(t);let i=0,o=0,r=le(n);const l=r.triples;let a=pe(n),p=se(n),s=l.filter((e=>3==e.type&&e.index>4)).length/3;s+=l.filter((e=>3==e.type&&e.index===D.index_change+1)).length/3,i+=s,o+=s;var c=function(e,t){if(e.filter((e=>3!=e.type&&e.index>1&&e.index<9)).length>=13&&0==t.filter((e=>3==e.type||1==e.index||9==e.index)).length)return{open:1,closed:1};return{open:0,closed:0}}(n,t);i+=c.open,o+=c.closed;var d=function(e){for(var t=0;t<e.length;t++){var n=ie(e,e[t].index,e[t].type),i=ie(e,e[t].index+1,e[t].type),o=ie(e,e[t].index+2,e[t].type);if(2==n&&2==i&&2==o)return{open:0,closed:1}}return{open:0,closed:0}}(l);i+=d.open,o+=d.closed,parseInt(a.length/3)>=4&&(i+=2,o+=2);var u=function(e){for(var t=1;t<=9;t++)if(e.filter((e=>e.index==t&&e.type<3)).length>=9)return{open:2,closed:2};return{open:0,closed:0}}(a);i+=u.open,o+=u.closed;var f=function(e){for(var t=1;t<=7;t++)if(e.filter((e=>e.index==t||e.index==t+1||e.index==t+2)).length>=9)return{open:2,closed:1};return{open:0,closed:0}}(p);i+=f.open,o+=f.closed,8==a.filter((e=>3==e.type&&e.index>=5)).length&&(i+=2,o+=2),a.concat(r.pairs).filter((e=>3==e.type||1==e.index||9==e.index)).length+3*p.filter((e=>1==e.index||9==e.index)).length>=13&&(i+=1,o+=2),n.filter((e=>3==e.type||1==e.index||9==e.index)).length>=13&&(i+=3,o+=2);var y=function(e){for(let t=0;t<=2;t++)for(let n=1;n<=9;n++)if(e.some((e=>e.type==t&&e.index==n))){if(9==n)return{open:1,closed:2}}else n=10;return{open:0,closed:0}}(l);i+=y.open,o+=y.closed;var h=function(e,t,n){if(e.concat(n).filter((e=>3!=e.type&&(1==e.index||9==e.index))).length+3*t.filter((e=>1==e.index||9==e.index)).length>=13)return{open:1,closed:1};return{open:0,closed:0}}(a,p,r.pairs);return i+=h.open,o+=h.closed,(n.filter((e=>3==e.type||0==e.type)).length>=13||n.filter((e=>3==e.type||1==e.type)).length>=13||n.filter((e=>3==e.type||2==e.type)).length>=13)&&(i+=2,o+=3),(n.filter((e=>0==e.type)).length>=13||n.filter((e=>1==e.type)).length>=13||n.filter((e=>2==e.type)).length>=13)&&(i+=3,o+=3),a.filter((e=>3==e.type&&e.index>=5)).length>=9&&(i+=10,o+=10),{open:i,closed:o}}let ue=null;function fe(e){console.log(e)}setTimeout((()=>{ue=window.mjcore.E_PlayOperation}),4e3);const ye="G",he="C",ge="F";let xe=ye,me=!0,ve=!0,we=[],_e=[],ke=[[]],be=[],Ie=0,Me=[];const Ee=new WeakMap,Ne=e=>(4+D.localPosition2Seat(e)-D.index_ju)%4+1,Pe=(e,t)=>e<1||e>9?0:4-Me.filter((n=>n.index==e&&n.type==t)).length;function Re(e,t,n){if(void 0!==n&&2==n.length&&(n=te(n))[0].type==n[1].type&&n[1].index-n[0].index==1)if(e==n[1].index+1&&t==n[1].type){if(_e[0].some((e=>e.index==n[0].index-1&&e.type==t)))return 0}else if(e==n[0].index-1&&t==n[0].type&&_e[0].some((e=>e.index==n[1].index+1&&e.type==t)))return 0;return _e[0].some((n=>n.index==e&&n.type==t))?0:Pe(e,t)}function Ce(e){var t=10;if(Le())if(De()>0)t*=1.5;else if(qe()<0){t*=1+(qe()/3e4>-.5?qe()/3e4:-.5)}if(t*=1==Ne(0)?1.1:1,fe("Would fold this hand below "+Number(1-(e[0].value*e[0].value*t+t/3)/100).toFixed(2)+" safety."),void 0!==e[2])var n=(Te(e[0].tile)+Te(e[1].tile)+Te(e[2].tile))/3;else n=-1;var i=1-(e[0].value*e[0].value*t+t/3)/100;return i>Te(e[0].tile)&&i>n&&(fe("Tile Safety "+Te(e[0].tile)+" of "+X(e[0].tile)+" is too dangerous. FOLD!"),!0)}function Ge(e,t){return!(e<3-(2-Ie/35))&&!(t.closed>=1&&Le()&&(qe()<0||De()<0&&De()>=-1e3))}function qe(){const[e,...t]=D.players.map((e=>e.score));return Math.max(...t)-e}function De(){const[e,...t]=D.players.map((e=>e.score));return Math.min(...t)-e}function Le(){return 3===D.index_ju||D.index_change>0}function Oe(e){let t=[0,100,100,100];for(let n=1;n<4;n++)null==Se(n,e)?(t[n]=ze(n,e),t[n]<=0||(t[n]*=1+Z(e)/8,$e(n,e.type)&&(t[n]*=1.3),t[n]<5&&(t[n]=5),t[n]*=Ae(n)/100)):t[n]=0;return(t[1]+t[2]+t[3]+Math.max.apply(null,t))/4}function Ae(e){if(t=e,0===window.view.DesktopMgr.player_link_state[D.localPosition2Seat(t)])return 0;var t;if(D.players[e].hand.length<13)var n=parseInt(185-8*D.players[e].hand.length-1.5*Ie);else n=15-Ie;if(n>80)n=80;else if((e=>{const t=D.players[e];return t.liqibang._activeInHierarchy||t.container_qipai.last_is_liqi})(e))n=100;else if(n<0)return 0;return 1==Ne(e)&&(n+=10),n+=10*ee(ke[e]),($e(e,0)||$e(e,1)||$e(e,2))&&(n+=10),n}function Se(e,t){for(var n=_e[e].length-1;n>=0;n--)if(_e[e][n].index==t.index&&_e[e][n].type==t.type)return _e[e][n];return null}function Te(e){return 1-Math.pow(Oe(e)/10,2)/100}function $e(e,t){return!(ke[e].length<=3||ke[e].some((e=>e.type!=t&&3!=e.type)))&&!(_e[e].filter((e=>e.type==t)).length>=_e[e].length/6)}function je(e){let t=0;for(let n=1;n<4;n++)t+=ze(n,e);return t/3}function ze(e,t){var n=Pe(t.index,t.type),i=n+ie(we,t.index,t.type),o=We(e,t),r=0;if(r+=n*(i+1)*6,1===D.players[e].hand.length||3===t.type)return r*o;var l=Pe(t.index-3,t.type)+ie(we,t.index-3,t.type),a=We(e,{index:t.index-3,type:t.type}),p=Pe(t.index-2,t.type),s=Pe(t.index-1,t.type),c=Pe(t.index+1,t.type);return r+=s*p*(i+l)*a,r+=c*Pe(t.index+2,t.type)*(i+(Pe(t.index+3,t.type)+ie(we,t.index+3,t.type)))*We(e,{index:t.index+3,type:t.type}),r+=s*c*i,(r*=o)>180&&(r=180+(r-180)/4),r/=1.6}function We(e,t){let n=99;for(var i=0;i<4;i++){var o=Se(i,t);if(e===i&&null!==o)return 0;null!==o&&Ee.get(o)[e]<n&&(n=Ee.get(o)[e])}return 0==n?0:1==n?ke[e].length>0?.3:.9:2==n?ke[e].length>0?.8:.95:1}function Je(e){return xe==he?function(){for(var e=[],t=0;t<we.length;t++){const n=[...we];n.splice(t,1);const i=oe(n),o=i.length/2,r=ae(n,i),l=de(n,ke[0]);let a=o/2,p=ee(i),s=l,c=0,d={index:9,type:9,dora:!1};be.forEach((e=>{if(e.index!=d.index||e.type!=d.type){let t=[...r];t.push(e);let i=Re(e.index,e.type),o=i/be.length,d=oe(t);if(d.length>0){a+=o/2,p+=ee(d)*o;let t=de(n,ke[0]);t.open-=l.open,t.closed-=s.closed,t.open>0&&(l.open+=t.open*o),t.closed>0&&(l.closed+=t.closed*o),c+=i*((3-je(e)/90)/2)}}d=e}));const u=He(n,we[t],a,l,p,c);e.push({tile:we[t],value:u,efficiency:a,dora:p,yaku:l,waits:c})}return e.sort(((e,t)=>t.value-e.value))}():e.map(((t,n)=>{const i=[...e];return i.splice(n,1),Ue(i,t)})).sort(((e,t)=>t.value-e.value))}function Fe(e,t,n){-1===e.findIndex((e=>e.index==t&&e.type==n))&&e.push({index:t,type:n,dora:!1})}function Ue(e,t){let n=[];for(let t=0;t<e.length;t++){if(Fe(n,e[t].index,e[t].type),3==e[t].type)continue;let i=ie(e,e[t].index-1,e[t].type),o=ie(e,e[t].index+1,e[t].type);0==i&&e[t].index-1>=1&&Fe(n,e[t].index-1,e[t].type),0==o&&e[t].index+1<=9&&Fe(n,e[t].index+1,e[t].type)}let{triples:i,pairs:o}=le(e),l=re(ke[0]),a=parseInt(i.length/3)+l;a=a>3.5?3.5:a,a+=o.length/2>0?.5:0;let p=a,s=ee(i.concat(o,ke[0])),c=s,d=de(e,ke[0]),u=d,f=0;for(var y=e,h=[],g=[],x=0;x<n.length;x++){if((P=Re(n[x].index,n[x].type,ae(y,i.concat(o))))<=0)continue;y.push(n[x]);var m=le(y),v=m.triples,w=m.pairs,_=parseInt(v.length/3)+l;_=_>3.5?3.5:_,_+=w.length/2>0?.5:0,_-=a;var k=ee(v.concat(w,ke[0]))-s;let t=[];for(var b=0;b<e.length;b++){var I=ie(y,y[b].index,y[b].type);if(3==y[b].type&&I>=2){Fe(t,y[b].index,y[b].type);continue}I>=2&&Fe(t,y[b].index,y[b].type);let e=ie(y,y[b].index-1,y[b].type),n=ie(y,y[b].index-2,y[b].type),i=ie(y,y[b].index+1,y[b].type),o=ie(y,y[b].index+2,y[b].type);y[b].index-1>=1&&I==e+1&&(i>0||n==I)&&Fe(t,y[b].index-1,y[b].type),y[b].index+1<=9&&I==i+1&&(e>0||o==I)&&Fe(t,y[b].index+1,y[b].type)}for(var M=0;M<t.length;M++)n[x].type==t[M].type&&(g.some((e=>X(e.tile1)==X(t[M])&&X(e.tile2)==X(n[x])||X(e.tile1)==X(n[x])&&X(e.tile2)==X(t[M])))||g.push({tile1:n[x],tile2:t[M]}));var E=P/be.length;ve||3!=ie(y,n[x].index,n[x].type)||(E*=2),k>0&&(c+=k*E);var N=d;_>0&&(p+=_*E,(N=de(y,ke[0])).open-=d.open,N.closed-=d.closed,N.open>0&&(u.open+=N.open*E),N.closed>0&&(u.closed+=N.closed*E),parseInt(v.length/3)+l==4&&2==w.length&&(f+=P*((3-je(n[x])/90)/2))),h.push({tile:n[x],efficiency:_,dora:k,yaku:N}),y.pop()}for(x=0;x<g.length;x++){let e=0;var P=Re(g[x].tile1.index,g[x].tile1.type),R=Re(g[x].tile2.index,g[x].tile2.type);if(P<=0||R<=0)continue;if(g[x].tile1.index==g[x].tile2.index&&g[x].tile1.type==g[x].tile2.type){if(1==R)continue;e=r(P,2)/r(be.length,2)}else e=r(P,1)*r(R,1)/r(be.length,2);y.push(g[x].tile1),y.push(g[x].tile2);let t=h.find((e=>X(e.tile)==X(g[x].tile1))),n=h.find((e=>X(e.tile)==X(g[x].tile2)));null==n&&(n={efficiency:0,dora:0,yaku:{open:0,closed:0}});var C=t.efficiency+n.efficiency,G=t.dora+n.dora,q={open:t.yaku.open+n.yaku.open,closed:t.yaku.closed+n.yaku.closed},D=le(y),L=D.triples,O=D.pairs,A=parseInt(L.length/3)+l;A=A>3.5?3.5:A,A+=O.length/2>0?.5:0,A-=a+C;var S=ee(L.concat(O,ke[0]))-(s+G);if(S>0&&(c+=S*e),A>0){p+=A*e;let t=de(y,ke[0]);t.open-=d.open+q.open,t.closed-=d.closed+q.closed,t.open>0&&(u.open+=t.open*e),t.closed>0&&(u.closed+=t.closed*e)}y.pop(),y.pop()}return{tile:t,value:He(e,t,p,u,c,f),efficiency:p,dora:c,yaku:u,waits:f}}function He(e,t,n,i,o,r){let l=void 0!==t?Te(t):1;const a=ve?i.closed:i.open;let p=le(e.concat(ke[0])),s=ae(e,p.triples.concat(p.pairs));return function(e,t,n){return xe==he?parseInt(e.pairs.length/2)>=6:n>=3.5&&(3==parseInt(e.triples.length/3)&&parseInt(e.pairs.length/2)>=1&&(parseInt(t.length/2)>=1||parseInt(e.pairs.length/2)>=2)||4==parseInt(e.triples.length/3))}(p,s.filter((t=>{const n=ie(e,t.index,t.type);return 3===t.type?2===n:2==n||(ie(e,t.index-1,t.type)>=1||ie(e,t.index+1,t.type)>=1||ie(e,t.index-2,t.type)>=1||ie(e,t.index+2,t.type)>=1)&&n>=1})),n)&&(n+=r/8),(1*n+.5*a+.3*o+.5*l)/2.3}function Ye(e){let t=e[0].tile;if(!ve){let n=-1;for(let i=0;i<e.length&&!(e[i].yaku.open>n+.01&&(t=e[i].tile,n=e[i].yaku.open,e[i].yaku.open>=1));i++);}return t}const Be=e=>{const t=D.oplist;e===t[t.length-1]?.type&&_({type:null})},Ve=new WeakSet;function Ke(){return L("a",(async e=>{if("NewRound"===e.name&&((e=>{Y.clear(),H.splice(0);for(const e of"pms")V(`0${e}`);e&&K(e)})(),ve=!ke[0].length,xe=ye,me=!0,await n(2e3)),!e.data?.operation&&"NewRound"!==e.name)return;await n(1500);const t=e.data.operation?.operation_list??D.oplist;if(!t.length)return;K(D.dora.map(X));const i=D.seat2LocalPosition(D.index_player);we=D.players[0].hand.map((e=>e.val)),_e=D.players.map((e=>{const t=e.container_qipai,n=t.pais.map((e=>e.val));return t.last_pai&&n.push(t.last_pai.val),n}));for(let e=1;e<4;e++){const t=D.players[e].hand?.some((e=>!Ve.has(e)))||D.players[e].container_ming.pais.length>ke[e].length;_e.forEach(((n,o)=>{const r=n.length-1,l=e<o&&(e<=i||0===i);n.some(((n,i)=>{let o=Ee.get(n);if(o||(o=[0,0,0,0],Ee.set(n,o)),t){if(i===r&&l)return!0;++o[e]}}))})),D.players[e].hand.forEach((e=>Ve.add(e)))}Ie=D.left_tile_count,ke=D.players.map((e=>e.container_ming.pais.map((e=>e.val)))),Me=[...D.dora,...we,..._e.flat(),...ke.flat()],be=[];for(let e=0;e<=3;e++)for(let t=1;t<=9&&(3!=e||8!=t);t++)for(let n=1;n<=Pe(t,e);n++)be.push({index:t,type:e,dora:!1});if(fe("### OWN TURN ### - Danger: "+(Ae(1)+Ae(2)+Ae(3)+Math.max(Ae(1),Ae(2),Ae(3)))/4),xe!=ge){let e=re(we.concat(ke[0]));oe(we).length/2>=5&&e<2&&ve?(console.info("chiitoi"),xe=he,me=!1):xe!==ye&&(console.info("general"),xe=ye,me=!0)}t.sort(((e,t)=>t.type-e.type)),t.forEach((e=>{const t=e.type;switch(t){case ue.an_gang:case ue.add_gang:break;case ue.ming_gang:_({type:null});break;case ue.zimo:case ue.rong:_(e);break;case ue.eat:case ue.peng:console.info("Consider call on "+X(Qe())),function(e,t){var n=Ue(we),i=we.concat([Qe()]),o=le(we),r=le(i),l=-1,a=ae(r.triples,o.triples.concat(Qe()));if(a=te(a),r.triples.length<=o.triples.length||null==typeof a[0]||null==typeof a[1])return fe("Call would form no new triple! Declined!"),Be(t),!1;for(var p=0;p<e.length;p++)if(e[p]==X(a[0])+"|"+X(a[1])||e[p]==X(a[1])+"|"+X(a[0])){ke[0].push(a[0]),ke[0].push(a[1]),ke[0].push(Qe());var s=Ye(Je(i=ae(we,[a[0],a[1]]))),c=Ue(i=ae(i,[s]));c.tile=s,r=le(i),ke[0].pop(),ke[0].pop(),ke[0].pop(),fe("Combination found: "+e[p]),l=p}if(-1==l)return Be(t),fe("Could not find combination. Call declined!"),!1;if(Ce([c])&&(me=!1),!me)return fe("Strategy allows no calls! Declined!"),Be(t),!1;if(c.yaku.open<.01)return fe("Not enough Yaku! Declined! "+c.yaku.open+"<0.01"),Be(t),!1;if(r.triples.length<o.triples.length)return fe("Next discard would destroy a triple. Declined!"),Be(t),!1;if(3==parseInt(o.triples.length/3)&&1==parseInt(o.pairs.length/2))return fe("Call would destroy last pair! Declined!"),Be(t),!1;if(n.efficiency<1&&1===Ne(0))fe("Call accepted because of bad hand and dealer position!");else if(c.yaku.open+ee(we)>=3&&n.yaku.open+n.dora>c.yaku.open+.7*c.dora)fe("Call accepted because of high value hand!");else if(Z(Qe())+c.yaku.open>=n.yaku.closed+.9)fe("Call accepted because it boosts the value of the hand!");else{if(ve||!(c.yaku.open+c.dora>=.9*(n.yaku.open+n.dora)))return Be(t),fe("Call declined because it does not benefit the hand!"),!1;fe("Call accepted because hand is already open!")}_({type:t,index:l}),ve=!1}(e.combination,t);break;case ue.dapai:!function(){let e=null,t=1e3,n=Je(we);if(xe==ge||Ce(n)){let n=we.map((e=>({tile:e,danger:Oe(e)})));fe("Danger Levels:");for(var i=0;i<n.length;i++)fe(X(n[i].tile)+" : "+n[i].danger),n[i].danger<t&&(e=n[i].tile,t=n[i].danger);return Ze(e),e}e=Ye(n),D.oplist.some((e=>e.type===ue.liqi))&&Ie>3?function(e){const{combination:t}=D.oplist.find((e=>e.type===ue.liqi));if(fe(JSON.stringify(t)),!Xe)return Xe=!0,console.log("skip first riichi",e[0].tile),Ze(e[0].tile);for(let n=0;n<e.length;n++)for(let i=0;i<t.length;i++)if("0"===t[i].charAt(0)&&t.push("5"+t[i].charAt(1)),X(e[n].tile)==t[i]&&Ge(e[n].waits,e[n].yaku)){let o=!1;return X(e[n].tile)==X(we[we.length-1])&&(o=!0),console.log("Call Riichi!",t[i],o),void _({type:7,tile:t[i],moqie:o})}fe("Riichi declined!"),Ze(e[0].tile)}(n):Ze(e)}()}}))}))}function Qe(){return null===D.lastqipai?{index:0,type:0,dora:!1}:D.lastqipai.val}let Xe=!1;function Ze(e){const t=X(e);fe("Discard: "+t);const n=we.findIndex((t=>t.index===e.index&&t.type===e.type&&t.dora===e.dora));_e[0].push(we[n]),_({type:1,tile:t,moqie:n===we.length-1})}let et=null;!async function(){await async function(){for(;!window.app?.NetAgent;)await n(500);for(setInterval((()=>s.heatbeat({no_operation_counter:10*Math.random()})),6e4);await n(100),!window.uiscript?.UI_Lobby?.Inst?.enable;)if(q()?.active){D=q(),k().then((e=>{I.emit("s",e),e.game_restore.actions.forEach(G)}));break}if(!D){const e=()=>n(10).then((()=>{D=q(),D&&I.off("i",e)}));I.on("i",e)}const e=window.app.NetAgent;[["ActionPrototype",{once:!1,runWith:G}],["NotifyGameEndResult",N],["NotifyGameTerminate",N],...b.map((e=>["Notify"+e,P]))].forEach((([t,n])=>e.AddListener2MJ(t,n))),[["RoomKickOut",P],["ClientMessage",P],["RoomGameStart",R],["MatchGameStart",R]].forEach((([t,n])=>e.AddListener2Lobby("Notify"+t,n)))}(),T(),J(),et=Ke()}();const tt=document.createElement("div");tt.id="app",document.body.append(tt);
